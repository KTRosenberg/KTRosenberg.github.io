<meta charset="utf-8">
<embed 
loop="true" src="Tear_ver_5_6_50.mp3" autostart="true" width=2 height="0"> 
</embed>
<tr>
<td><canvas id=canvas1 width=1000 height=1000></td>
<td width=50></td>
<div style="display:none;">
  <img id="mirror_sprites" src="sprites/mirror_4_pos_sheet.png"
       width="800" height="200">
</div>
</tr>

<script src=drawlib1.js></script>
<script>
    // user input //////////////////////////////////////////////////////////////
    // control states
    var up = false; // w 87
    var down = false; // s 83
    var left = false; // a 65
    var right = false; // d 68
    var diagonalRight = false; // e 69
    var diagonalLeft = false; // q 81
    var gameIsRunning = true;

    // control options
    var Controls = {
        up : 87,                 
        down : 83,
        left : 65,
        right : 68,  
        diagonalRight : 69,
        diagonalLeft : 81,

        leaveGame : 76
    };
    var curControl = Controls.up;
    
    function keyDownHandler(event) {
        if (event.defaultPrevented) {
            return;
        }
        changeControl = true;
        // up
        if (event.keyCode == Controls.up) {
            up = true
        }
        // down
        else if (event.keyCode == Controls.down) {
            down = true;
        }
        // left
        else if (event.keyCode == Controls.left) {
            left = true;
        }
        // right
        else if (event.keyCode == Controls.right) {
            right = true;
        }
        // diagonal right
        else if (event.keyCode == Controls.diagonalRight) {
            diagonalRight = true;
        }
        // diagonal left
        else if (event.keyCode == Controls.diagonalLeft) {
            diagonalLeft = true;
        }
        else {
            changeControl = false;
            if (event.keyCode == Controls.leaveGame) {
                gameIsRunning = false;
            }
        }
        if (changeControl) {
            curControl = event.keyCode;
        }
    }

    function keyUpHandler(event) {
        if (event.defaultPrevented) {
            return;
        }

        // up
        if (event.keyCode == Controls.up) {
            up = false
        }
        // down
        else if (event.keyCode == Controls.down) {
            down = false;
        }
        // left
        else if (event.keyCode == Controls.left) {
            left = false;
        }
        // right
        else if (event.keyCode == Controls.right) {
            right = false;
        }
        // diagonal right
        else if (event.keyCode == Controls.diagonalRight) {
            diagonalRight = false;
        }
        // diagonal left
        else if (event.keyCode == Controls.diagonalLeft) {
            diagonalLeft = false;
        }
    }
    window.addEventListener('keydown', keyDownHandler, false);
    window.addEventListener('keyup', keyUpHandler, false);
    
    function getOrientName(orient) {
        switch (orient) {
        // up
        case Controls.up: {
            return "O_UP";
        }
        // down
        case Controls.down: {
            return "O_DOWN";
        }
        // left
        case Controls.left: {
            return "O_LEFT";
        }
        // right
        case Controls.right: {
            return "O_RIGHT";
        }
        // diagonal right
        case Controls.diagonalRight: {
            return "O_DIAGONAL_RIGHT";
        }
        // diagonal left
        case Controls.diagonalLeft: {
            return "O_DIAGONAL_LEFT";
        }
        }
    }

    // object types ////////////////////////////////////////////////////////////

    // laser projectile
    
    var count = 0;
    function drawProjectile(g, projectile) {
        // outer shape

        g.fillStyle = "red";
        /*
        g.fillRect(projectile.x - (projectile.width / 2), 
                   projectile.y - (projectile.height / 2),  
                   projectile.width, projectile.height);
        */
        g.translate(projectile.x, projectile.y);
        var rotation = (count) * (Math.PI / 180);
        if (count == 360) {
            count = 0;
        }
        
        g.rotate(rotation);
        g.fillRect(-(projectile.width / 2), -(projectile.height / 2),  
                   projectile.width, projectile.height);
        g.rotate(-rotation);

        // inner shape
        g.fillStyle = "yellow";
        g.rotate(rotation / 4);
        g.fillRect(-(projectile.width / 4), -(projectile.height / 4),  
           projectile.width / 2, projectile.height / 2);         
        g.setTransform(1, 0, 0, 1, 0, 0);
        
        /*
        g.fillStyle = "rgba(0, 1, 0, 0.01)";
        g.fillRect(0, 0, 50, 50);
        
                g.fillRect(projectile.x - (projectile.width / 2),
                   projectile.y - (projectile.height / 2),
                   projectile.width, projectile.height * 4);
        */
        
        count += 20;                 
        
    }
    
    function translateProjectileBy(x, y, doWrapScreen) {
        this.x += x;
        this.y += y;
        if (doWrapScreen) {
            if (this.x > 1000) {
                this.x = 10;
            }
            else if (this.x < 0) {
                this.x = 990;
            } 
            if (this.y > 1000) {
                this.y = 10;
            }
            else if (this.y < 0) {
                this.y = 990;
            }
        }
 
    }
    function Projectile(x, y, width, height) {
        this.x = x;
        this.y = y;
        this.width = width;
        this.height = height;
        this.distPer = 20;
        this.orient = Controls.up;
        this.translateProjectileBy = translateProjectileBy;
    }
    
    // laser projectile object
    var laser = null;
    
    // mirrors
    function drawMirror(g) {
    }
    function Mirror(x, y, width, height) {
        this.x = x;
        this.y = y;
        this.drawMirror = drawMirror;
    }
    Mirror.orient = Controls.up;
    
    // main update loop ////////////////////////////////////////////////////////

    canvas1.Init = function() {
        laser = new Projectile((this.width / 2), (this.height / 2), 20, 20);
    }
    
    canvas1.update = function(g) {
        if (!gameIsRunning) {
            return;
        }
        
        Mirror.orient = curControl;
        /*
        console.log("up: " + up + "\ndown: " + down 
                    + "\nleft: " + left + "\nright: " + right 
                    + "\ndiagonal right: " + diagonalRight 
                    + "\ndiagonal left: " + diagonalLeft);
        */          
        console.log(getOrientName(Mirror.orient));
        
        ////////////////////////////////////////////////////////////////////////
        
        // background color
        g.fillStyle = "beige";
        g.fillRect(0, 0, this.width, this.height);
        
        // draw rectangular grid backdrop
        for (var row = 0; row < 5; ++row) {
            var rowEndPoint = row * 200;
            g.beginPath();
            g.moveTo(0, rowEndPoint);
            g.lineTo(this.width, rowEndPoint);
            g.stroke();
        }
        for (var col = 1; col < 5; ++col) {
            var colEndPoint = col * 200;
            g.beginPath();
            g.moveTo(colEndPoint, 0);
            g.lineTo(colEndPoint, this.height);
            g.stroke();        
        }
        
        
      /*
      var x = this.cursor.x;
      var y = this.cursor.y;
      var z = this.cursor.z;
      if (z == 0) {
         x = this.width  / 2 + 30 * Math.sin(time) ;
         y = this.height / 2 + 30 * Math.cos(time);
      }

      var freq = z == 0 ? 6 : 12;
      var f = .2;
      var angle = -2 * f * (Math.sin(freq * time) - 0.5);
      var angle2 =     f * (Math.cos(freq * time) - 1);

      var flapY = 40 * Math.sin(angle);
      var flapX = 40 * Math.cos(angle);

      var flapY2 = 40 * Math.sin(2 * angle2);
      var flapX2 = 40 * Math.cos(2 * angle2);

      g.moveTo(x-flapX-flapX2, y-flapY-flapY2);
      g.lineTo(x-flapX, y-flapY);
      g.lineTo(x, y);
      g.lineTo(x+flapX, y-flapY);
      g.lineTo(x+flapX+flapX2, y-flapY-flapY2);
      g.stroke();
      */
      
      drawProjectile(g, laser);
            
      laser.translateProjectileBy(0, -10, true);
   }

   draw2DCanvases([canvas1]);
</script>


